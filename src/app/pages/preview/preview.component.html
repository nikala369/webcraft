<div
  class="preview-container"
  [ngClass]="{ 'fullscreen-mode': isFullscreen() }"
>
  <!-- Main Introductory Text (hidden in fullscreen) -->
  <div class="preview-intro" *ngIf="!isFullscreen()">
    <h1 class="preview-main-title">Customize Your Website</h1>

    <p class="preview-main-subtitle">
      Your {{ currentPlan() }} plan gives you access to powerful customization
      tools. Make it uniquely yours in just a few minutes!
    </p>

    <div class="plan-indicator" style="margin-top: 1.5rem; user-select: none">
      <app-plan-badge [plan]="currentPlan()"></app-plan-badge>
    </div>
  </div>

  <!-- Progress Steps (hidden in fullscreen) -->
  <app-build-steps
    *ngIf="!isFullscreen()"
    [currentStep]="currentStep()"
    [steps]="['Select Plan', 'Customize Design', 'Publish Website']"
  ></app-build-steps>

  <!-- Preview Header (fixed in fullscreen) -->
  <div
    *ngIf="isFullscreen()"
    class="preview-header"
    [ngClass]="{ 'fullscreen-mode-border-remove': isFullscreen() }"
  >
    <!-- Theme Selector -->
    <app-theme-switcher
      *ngIf="!this.isViewOnlyStateService.isOnlyViewMode()"
      class="preview-header__left"
      (themeChange)="loadTheme($event)"
      [defaultThemeId]="defaultThemeId()"
      [plan]="currentPlan()"
    >
    </app-theme-switcher>

    <!-- View Toggle (Only on Desktop) -->
    <div class="preview-header__center" *ngIf="!isMobileView()">
      <!-- Desktop View Icon -->
      <div
        class="icon-container"
        [class.active]="viewMode() === 'view-desktop'"
        (click)="toggleView('view-desktop')"
        title="Desktop View"
      >
        <svg
          class="view-icon"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M20 4H4C2.89543 4 2 4.89543 2 6V15C2 16.1046 2.89543 17 4 17H20C21.1046 17 22 16.1046 22 15V6C22 4.89543 21.1046 4 20 4Z"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M8 20H16"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M12 17V20"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

      <!-- Mobile View Icon -->
      <div
        class="icon-container"
        [class.active]="viewMode() === 'view-mobile'"
        (click)="toggleView('view-mobile')"
        title="Mobile View"
      >
        <svg
          class="view-icon"
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            x="7"
            y="2"
            width="10"
            height="20"
            rx="3"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M7 6H17"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
          />
          <path
            d="M7 18H17"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
          />
          <circle cx="12" cy="20" r="1" fill="currentColor" />
        </svg>
      </div>

      <!-- Fullscreen/Exit Fullscreen Icon -->
      <div
        class="icon-container fullscreen-icon-container"
        (click)="toggleFullscreen()"
        title="{{ isFullscreen() ? 'Exit Fullscreen' : 'Enter Fullscreen' }}"
      >
        <!-- Enter Fullscreen Icon -->
        <svg
          *ngIf="!isFullscreen()"
          class="view-icon fullscreen-icon"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M8 3H5C3.89543 3 3 3.89543 3 5V8"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M16 3H19C20.1046 3 21 3.89543 21 5V8"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M8 21H5C3.89543 21 3 20.1046 3 19V16"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M16 21H19C20.1046 21 21 20.1046 21 19V16"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>

        <!-- Exit Fullscreen Icon -->
        <svg
          *ngIf="isFullscreen()"
          class="view-icon fullscreen-icon"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          xmlns="http://www.w3.org/2000/svg"
        >
          <!-- Top arrow: points downward -->
          <polyline points="16 4 12 8 8 4" />
          <!-- Bottom arrow: points upward -->
          <polyline points="16 20 12 16 8 20" />
          <!-- Left arrow: points rightward -->
          <polyline points="4 8 8 12 4 16" />
          <!-- Right arrow: points leftward -->
          <polyline points="20 8 16 12 20 16" />
        </svg>
      </div>
    </div>

    <!-- Font Selector -->
    <app-font-picker
      *ngIf="!this.isViewOnlyStateService.isOnlyViewMode()"
      class="preview-header__right"
      (fontChange)="handleFontUpdate($event)"
    >
    </app-font-picker>
  </div>

  <!-- Main Preview Area (fullscreen when in fullscreen mode) -->
  <div
    class="preview-wrapper"
    [ngClass]="[
      viewMode(),
      this.isViewOnlyStateService.isOnlyViewMode() ? 'view-only-mode' : ''
    ]"
  >
    <!-- Overlays: Shown in non-fullscreen mode -->
    <div class="preview-hover-overlay" *ngIf="!isFullscreen()">
      <ng-container *ngIf="!hasStartedBuilding()">
        <button class="start-fullscreen-btn" (click)="startBuilding()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
              fill="currentColor"
            />
          </svg>
          Start Customizing
        </button>
      </ng-container>
      <ng-container *ngIf="hasStartedBuilding()">
        <button class="continue-editing-btn" (click)="editBuilding()">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z"
              fill="currentColor"
            />
          </svg>
          Continue Editing
        </button>
        <button class="view-mode-btn" (click)="openViewOnly()">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
              fill="currentColor"
            />
          </svg>
          View Mode
        </button>
      </ng-container>
    </div>

    <ng-container *ngIf="currentPlan() === 'standard'">
      <app-standard-structure
        [isMobileLayout]="viewMode() === 'view-mobile' || isMobileView()"
        [isMobileView]="viewMode()"
        [currentPage]="currentPage()"
        [selectedFont]="selectedFont()"
        [customizations]="customizations"
        (componentSelected)="handleComponentSelection($event)"
      >
      </app-standard-structure>
    </ng-container>

    <ng-container *ngIf="currentPlan() === 'premium'">
      <!-- Premium Structure Code (if applicable) -->
    </ng-container>
  </div>

  <!-- Customization Modal (for updates via modal) -->
  <div
    class="modal-overlay"
    *ngIf="
      selectedCustomization() && !this.isViewOnlyStateService.isOnlyViewMode()
    "
  >
    <app-component-customizer
      *ngIf="selectedComponent()"
      [componentKey]="selectedComponent()!.key"
      [componentPath]="selectedComponent()?.path"
      [initialData]="selectedCustomization()?.data"
      (update)="handleComponentUpdate($event)"
      (close)="selectedComponent.set(null)"
    >
    </app-component-customizer>
  </div>

  <!-- Save and Reset Actions (fixed at bottom in fullscreen) -->
  <div
    *ngIf="isFullscreen() && !this.isViewOnlyStateService.isOnlyViewMode()"
    class="preview-footer"
    [ngClass]="{ 'fullscreen-mode-border-remove': isFullscreen() }"
  >
    <button class="btn btn--secondary" (click)="resetCustomizations()">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"
          fill="currentColor"
        />
      </svg>
      Reset
    </button>

    <button class="btn btn--primary" (click)="saveAllChanges()">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15C9 16.66 10.34 18 12 18C13.66 18 15 16.66 15 15C15 13.34 13.66 12 12 12ZM7 7H15V9H7V7Z"
          fill="currentColor"
        />
      </svg>
      Save Changes
    </button>
  </div>

  <!-- Post-Save Checkout Section (visible after saving) -->
  <app-checkout-panel
    *ngIf="
      !isMobileView() &&
      hasStartedBuilding() &&
      !isFullscreen() &&
      hasSavedChanges()
    "
    (checkoutClicked)="proceedToCheckout()"
  ></app-checkout-panel>

  <div style="height: 30px"></div>
</div>
